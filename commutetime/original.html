<!DOCTYPE html>
<!-- saved from url=(0068)http://projects.flowingdata.com/2015/commute-time/animated-road.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>Average Commute Time Animated</title>
<link rel="stylesheet" href="./style/animation.css" type="text/css" media="screen">
</head>
<body><div id="road-wrapper">
<div id="county-roads"><svg width="960" height="232" id="roads"><g><text id="lab13143" x="20" y="9">Haralson County, Georgia</text><text id="lab34037" x="20" y="33">Sussex County, New Jersey</text><text id="lab28097" x="20" y="57">Montgomery County, Mississippi</text><text id="lab50011" x="20" y="81">Franklin County, Vermont</text><text id="lab37183" x="20" y="105">Wake County, North Carolina</text><text id="lab53069" x="20" y="129">Wahkiakum County, Washington</text><text id="lab6031" x="20" y="153">Kings County, California</text><text id="lab46117" x="20" y="177">Stanley County, South Dakota</text><text id="lab41051" x="20" y="201">Multnomah County, Oregon</text><text id="lab35025" x="20" y="225">Lea County, New Mexico</text><text id="vlab13143" x="270" y="9">30.0 minutes commuting to work, on average</text><text id="vlab34037" x="270" y="33">37.7</text><text id="vlab28097" x="270" y="57">20.3</text><text id="vlab50011" x="270" y="81">27.1</text><text id="vlab37183" x="270" y="105">23.7</text><text id="vlab53069" x="270" y="129">30.8</text><text id="vlab6031" x="270" y="153">21.4</text><text id="vlab46117" x="270" y="177">13.7</text><text id="vlab41051" x="270" y="201">24.8</text><text id="vlab35025" x="270" y="225">17.9</text><line class="roadline" x1="8" x2="980" y1="-7" y2="-7" stroke-dasharray="8 20"></line><line class="roadline" x1="15" x2="980" y1="17" y2="17" stroke-dasharray="8 20"></line><line class="roadline" x1="2" x2="980" y1="41" y2="41" stroke-dasharray="8 20"></line><line class="roadline" x1="9" x2="980" y1="65" y2="65" stroke-dasharray="8 20"></line><line class="roadline" x1="12" x2="980" y1="89" y2="89" stroke-dasharray="8 20"></line><line class="roadline" x1="6" x2="980" y1="113" y2="113" stroke-dasharray="8 20"></line><line class="roadline" x1="9" x2="980" y1="137" y2="137" stroke-dasharray="8 20"></line><line class="roadline" x1="2" x2="980" y1="161" y2="161" stroke-dasharray="8 20"></line><line class="roadline" x1="4" x2="980" y1="185" y2="185" stroke-dasharray="8 20"></line><line class="roadline" x1="9" x2="980" y1="209" y2="209" stroke-dasharray="8 20"></line><g class="vehicle" id="v13143" width="20" height="10" transform="translate(77.75500000000001,0)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v34037" width="20" height="10" transform="translate(57.789124668435,24)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v28097" width="20" height="10" transform="translate(124.46551724137932,48)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v50011" width="20" height="10" transform="translate(88.13450184501846,72)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v37183" width="20" height="10" transform="translate(103.64746835443037,96)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v53069" width="20" height="10" transform="translate(75.14431818181819,120)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v6031" width="20" height="10" transform="translate(116.93668224299067,144)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v46117" width="20" height="10" transform="translate(193.901094890511,168)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v41051" width="20" height="10" transform="translate(98.16310483870967,192)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g><g class="vehicle" id="v35025" width="20" height="10" transform="translate(143.71201117318438,216)"><rect class="carbody" x="0" y="0" width="20" height="10"></rect><rect class="windshield" x="12" y="1" width="4" height="8"></rect><rect class="bumper" x="0" y="0" width="2" height="10"></rect><rect class="mirrors" x="11" y="-1" width="1" height="12"></rect></g></g></svg></div>
</div> 
<script src="./js/d3.v3.min.js"></script>
<script src="./js/queue.v1.min.js"></script>
<script>
var roadWidth = 960,
    roadHeight = 232;

var timeByFIPS = d3.map(),
    thedata,
    label,
    vehicle;
var formatTime = d3.format(".1f");
var timeScale = d3.scale.linear().domain([0,45]).range([0, 20000]);

var fids = [];

var roadsvg = d3.select("body #county-roads").append("svg")
    .attr("width", roadWidth)
    .attr("height", roadHeight)
    .attr("id", "roads")
  .append("g");

roadsvg.append("svg:image")
    .attr("xlink:href", "images/ajax-loader.gif")
    .attr("id", "progress-image")
    .attr("width", 43)
    .attr("height", 11)
    .attr("x", roadWidth / 2)
    .attr("y", roadHeight / 2);

var transitionQueue = [];

queue()
    .defer(d3.csv, "data/commute-times.csv", typeAndSet)
    .await(ready);


function ready(error, commute) {
    
    thedata = commute;
    
    // Randomly select 10 counties
    while (fids.length < 10) {
        var randomIndex = Math.floor(Math.random() * (commute.length-1));
        var id = commute[randomIndex].FIPS;
        if (fids.indexOf(id) == -1) {
            fids.push(id);
        }
    }
    
    // County labels
    label = roadsvg.selectAll("text")
        .data(fids)
      .enter().append("text")
        .attr("id", function(d) { return "lab" + d})
        .attr("x", 20)
        .attr("y", function(d, i) { return i * 24 + 9; })
        .text(function(d) {
            var county = timeByFIPS.get(d);
            var labelText = county['name'] + ", " + county['state'];
            return labelText; 
        });
    
    // Commute time labels
    valLabel = roadsvg.selectAll("text.val")
        .data(fids)
      .enter().append("text")
        .attr("id", function(d) { return "vlab" + d})
        .attr("x", 270)
        .attr("y", function(d, i) { return i * 24 + 9; })
        .text(function(d,i) {
            var county = timeByFIPS.get(d);
            var labelText = formatTime(county['minutes']);
            if (i == 0) {
                labelText += " minutes commuting to work, on average";
            }
            return labelText; 
        });
    
    // Road lines
    roadsvg.selectAll("line")
        .data(fids)
      .enter().append("line")
        .attr("class", "roadline")
        .attr("x1", function() { return Math.floor(Math.random() * 20); })
        .attr("x2", roadWidth+20)
        .attr("y1", function(d,i) { return i * 24 - 7; })
        .attr("y2", function(d,i) { return i * 24 - 7; })
        .attr("stroke-dasharray", "8 20");
    
    // Vehicle per county    
    vehicle = roadsvg.selectAll(".vehicle")
        .data(fids)
      .enter().append("g")
        .attr("class", "vehicle")
        .attr("id", function(d,i) { 
            transitionQueue.push(fids[i]);
            return "v" + fids[i]; 
        })
        .attr("width", 20)
        .attr("height", 10)
        .attr("transform", function(d,i) {
            return "translate(-20," + i * 24 + ")";
        });
      
     vehicle.append("rect")
        .attr("class", "carbody")
         .attr("x", 0)
         .attr("y", 0)
         .attr("width", 20)
         .attr("height", 10);
    vehicle.append("rect")
        .attr("class", "windshield")
        .attr("x", 12)
        .attr("y", 1)
        .attr("width", 4)
        .attr("height", 8);
    vehicle.append("rect")
        .attr("class", "bumper")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", 2)
        .attr("height", 10);
    vehicle.append("rect")
        .attr("class", "mirrors")
        .attr("x", 11)
        .attr("y", -1)
        .attr("width", 1)
        .attr("height", 12);
    
    repeat();
    
    roadsvg.select("#progress-image").remove();
}



var started = false;
var numEnds = 10;

function repeat() {
    
    // if (transitionQueue.length == 10) {
    if (numEnds == 10) {
        if (started) { replaceCounties(); }
        transitionQueue.forEach(function(fid) {
            var currY = fids.indexOf(fid) * 24;
            d3.select("#v" + fid)
                .attr("transform", "translate(-20," + currY + ")")
              .transition()
                .ease("linear")
                .duration(function() { 
                    return timeScale(timeByFIPS.get(fid)["minutes"]); 
                })
                .attr("transform", "translate("+roadWidth+"," + currY + ")")
                .each("end", function() {
                    numEnds += 1;
                    repeat();
                });
        });
        started = true;
        transitionQueue = [];
        numEnds = 0;
    }
    
}


function replaceCounties() {
    fids.forEach(function(fid) {
        replaceCounty(fid);
    });
}


function replaceCounty(FIPS) {
    var currPos = fids.indexOf(FIPS);
    // var newFIPS = FIPS;
    // while(fids.indexOf(newFIPS) != -1) {
        var randomIndex = Math.floor(Math.random() * (thedata.length-1));
        var newFIPS = thedata[randomIndex].FIPS;
    // }
    fids[currPos] = newFIPS;
    
    var newCounty = timeByFIPS.get(newFIPS);
    var labelText = newCounty['name'] + ", " + newCounty['state'];
    
    roadsvg.select("#lab" + FIPS).attr("id", "lab"+newFIPS);
    roadsvg.select("#lab" + newFIPS).text(labelText);
    
    var vtext = formatTime(newCounty['minutes']);
    if (currPos == 0) { vtext += " minutes commuting to work, on average"; }
    roadsvg.select("#vlab" + FIPS).attr("id", "vlab"+newFIPS);
    roadsvg.select("#vlab" + newFIPS).text(vtext);
    
    roadsvg.select("#v" + FIPS).attr("id", "v"+newFIPS);
    transitionQueue.push(newFIPS);
}



function typeAndSet(d) {
    
    d["minutes"] = +d["minutes"];
    d["moe"] = +d["moe"];
    
    timeByFIPS.set(d.FIPS, d);
    return d;
}

</script></body></html>